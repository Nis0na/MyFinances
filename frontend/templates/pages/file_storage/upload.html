{% extends base|default:"base/base.html" %}
{% block content %}
    <div class="card bg-base-100 p-3 mb-2 py-4">
        <div class="flex items-center justify-between">
            <a class="btn btn-neutral btn-outline btn-sm" href="{% url 'file_storage:dashboard' %}">
                Go back
            </a>
            <h2 class="text-xl" data-oob="invoices-title">File Storage - Upload Files</h2>
            <div></div>
        </div>
    </div>

    <!-- File Upload and Directory Upload Buttons -->
    <div class="flex justify-end space-x-4 my-4">
        <input type="file" id="singleFileInput" class="hidden" />
        <button type="button" id="singleFileButton" class="btn btn-sm btn-outline">Upload File</button>

        <input type="file" id="directoryInput" class="hidden" multiple webkitdirectory directory />
        <button type="button" id="directoryButton" class="btn btn-sm btn-outline">Upload Folder</button>
    </div>

    <div id="dropZone"
         class="w-full border-2 border-dashed border-primary p-6 text-center bg-base-100 rounded-lg hover:bg-base-200 transition-colors cursor-pointer">
        <span class="text-primary">Drag files or folders anywhere on the page</span>
    </div>

    <div class="overflow-x-auto mt-6">
        <div class="card bg-base-100 shadow-lg p-4">
            <table class="table w-full">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Directory</th>
                    <th>Size</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="fileList"></tbody>
            </table>
        </div>
    </div>

    <div class="flex justify-end mt-6">
        <button type="button" id="submitAllButton" class="btn btn-primary btn-sm">Submit All</button>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileList = document.getElementById('fileList');
        const submitAllButton = document.getElementById('submitAllButton');
        const singleFileButton = document.getElementById('singleFileButton');
        const directoryButton = document.getElementById('directoryButton');
        const singleFileInput = document.getElementById('singleFileInput');
        const directoryInput = document.getElementById('directoryInput');
        let filesToUpload = [];

        // Helper to format file size dynamically (KB, MB, GB)
        function formatSize(size) {
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let index = 0;
            while (size >= 1024 && index < units.length - 1) {
                size /= 1024;
                index++;
            }
            return `${size.toFixed(2)} ${units[index]}`;
        }

        // Helper to extract directory (exclude the file name)
        function extractDirectory(path) {
            const lastSlashIndex = path.lastIndexOf('/');
            return lastSlashIndex > 0 ? path.slice(0, lastSlashIndex) : 'N/A';
        }

        // Add file to the file list, override if file with the same name exists
        function addFile(file) {
            const existingIndex = filesToUpload.findIndex(f => f.name === file.name);
            if (existingIndex !== -1) {
                // Override existing file with the same name
                filesToUpload[existingIndex] = file;
            } else {
                // Add new file
                filesToUpload.push(file);
            }
            renderFileList();
        }

        // Remove file from the list
        function removeFile(index) {
            filesToUpload.splice(index, 1);
            renderFileList();
        }

        // Render file list as a table
        function renderFileList() {
            fileList.innerHTML = '';
            filesToUpload.forEach((file, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${file.name}</td>
                    <td>${file.webkitRelativePath ? extractDirectory(file.webkitRelativePath) : 'N/A'}</td>
                    <td>${formatSize(file.size)}</td>
                    <td><button class="btn btn-error btn-sm" onclick="removeFile(${index})">Remove</button></td>
                `;
                fileList.appendChild(row);
            });
        }

        // Single file selection via input button
        singleFileButton.addEventListener('click', () => {
            singleFileInput.click();
        });

        singleFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                addFile(file);
            }
        });

        // Directory selection via input button
        directoryButton.addEventListener('click', () => {
            directoryInput.click();
        });

        directoryInput.addEventListener('change', (event) => {
            const selectedFiles = event.target.files;
            for (const file of selectedFiles) {
                addFile(file);
            }
        });

        // Global drag-and-drop behavior (files can be dropped anywhere)
        ['dragenter', 'dragover'].forEach(eventName => {
            document.addEventListener(eventName, (e) => {
                e.preventDefault();
                document.body.classList.add('dragging-border');
                dropZone.classList.add('border-accent', 'bg-base-200');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, (e) => {
                e.preventDefault();
                document.body.classList.remove('dragging-border');
                dropZone.classList.remove('border-accent', 'bg-base-200');
            });
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            const items = e.dataTransfer.items;

            for (const item of items) {
                const entry = item.webkitGetAsEntry();
                if (entry.isFile) {
                    const file = item.getAsFile();
                    addFile(file);
                } else if (entry.isDirectory) {
                    traverseFileTree(entry);
                }
            }
        });

        // Recursive directory traversal
        function traverseFileTree(item, path = '') {
            if (item.isFile) {
                item.file((file) => {
                    file.relativePath = path + file.name;
                    addFile(file);
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                dirReader.readEntries((entries) => {
                    for (const entry of entries) {
                        traverseFileTree(entry, path + item.name + "/");
                    }
                });
            }
        }

        // Handle submit all button click
        submitAllButton.addEventListener('click', () => {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'file_storage:upload' %}";
            form.enctype = 'multipart/form-data';

            // Add the CSRF token as a hidden input
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            form.appendChild(csrfInput);

            // Append each file to the form as a file input
            filesToUpload.forEach((file) => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.name = 'files';  // Use 'files' to allow multiple files
                const dt = new DataTransfer();  // DataTransfer to simulate file input
                dt.items.add(file);  // Add file to the DataTransfer object
                fileInput.files = dt.files;  // Assign the files to the input
                form.appendChild(fileInput);
            });

            // Append the form to the body (temporarily) and submit it
            document.body.appendChild(form);
            form.submit();  // Submitting the form traditionally

            // Optionally, remove the form after submission
            form.remove();
        });
    </script>
{% endblock %}
