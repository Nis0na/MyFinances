{% extends base|default:"base/base.html" %}
{% load listfilters %}
{% block content %}
    {% load get_first_n_items from listfilters %}
    <div class="card bg-base-100 p-3 mb-2">
        <div class="grid grid-cols-3 items-center">
            <div class="flex items-center space-x-2"></div>
            <h2 class="text-xl text-center">Billing</h2>
            <div class="dropdown dropdown-bottom">
            </div>
        </div>
    </div>
    <div class="card bg-base-100 mb-2">
        <div class="card-body">
            <div class="card-title justify-between flex mb-6">
                Current Subscription Plan
                <div class="justify-end">
                    <button class="btn btn-primary float-right"
                            hx-get="{% url 'billing:stripe_customer_portal' %}?back=/dashboard/billing/"
                    >
                        Manage on the stripe dashboard
                    </button>
                </div>
            </div>


            <div class="space-y-8 lg:grid lg:grid-cols-3 sm:gap-6 xl:gap-10 lg:space-y-0">
                <div class="flex flex-col p-6 mx-auto max-w-lg text-center rounded-lg border bg-base-300 shadow xl:p-8
                            dark:border-gray-600  border-gray-100 ">
                    <h3 class="mb-4 text-2xl font-bold">Starter</h3>
                    <p class="font-light text-gray-500 sm:text-lg dark:text-gray-400">
                        For individual freelancers or small businesses with less recurring customers
                    </p>
                    <div class="flex justify-center items-baseline my-8">
                        <span class="mr-2 text-5xl font-extrabold">£5</span>
                        <span class="text-gray-500 dark:text-gray-400">/month</span>
                    </div>
                    <ul role="list" class="mb-8 space-y-4 text-left">
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Unlimited Customers</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span class="tooltip tooltip-primary tooltip-bottom"
                                  data-tip="Terms and extra charges may apply, check below!"
                            >
                                Unlimited Invoices <strong class="font-bold text-primary">*</strong>
                            </span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Basic Customer Onboarding</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Emailing (automated, normal & bulk)</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>File Storage (10 GB included!)</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Usage based pricing</span>
                        </li>
                    </ul>
                    {% if active_subscription and active_subscription.subscription_plan.name|lower == "starter" %}
                        <a href="#" class="btn btn-primary btn-outline btn-disabled">
                            Your active plan
                        </a>
                    {% else %}
                        <button class="btn btn-primary loading-htmx"
                                hx-post="{% url 'billing:change_plan' %}"
                                hx-vals='{"plan_name": "Starter"}'
                                hx-indicator="this"
                        >
                                <span class="loading-htmx-text">
                                    Change to plan
                                </span>
                            <span class="loading loading-spinner loading-htmx-loader"></span>
                        </button>
                    {% endif %}
                </div>
                <div class="flex flex-col p-6 mx-auto max-w-lg text-center rounded-lg border bg-base-300 shadow xl:p-8
                            dark:border-gray-600  border-gray-100 ">
                    <h3 class="mb-4 text-2xl font-bold">Growth</h3>
                    <p class="font-light text-gray-500 sm:text-lg dark:text-gray-400">
                        For small-medium sized businesses that require more features or have a wider customer base
                    </p>
                    <div class="flex justify-center items-baseline my-8">
                        <span class="mr-2 text-5xl font-extrabold">£15</span>
                        <span class="text-gray-500 dark:text-gray-400">/month</span>
                    </div>
                    <ul role="list" class="mb-8 space-y-4 text-left">
                        <li class="font-semibold text-gray-500 dark:text-gray-400">
                            Everything in Starter, plus:
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Unlimited Customers</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Automated Invoice Reminders</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Advanced Customer Onboarding</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>API Access</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>File Storage (50 GB included!)</span>
                        </li>
                    </ul>
                    {% if active_subscription and active_subscription.subscription_plan.name|lower == "growth" %}
                        <a href="#" class="btn btn-primary btn-outline btn-disabled">
                            Your active plan
                        </a>
                    {% else %}
                        <button class="btn btn-primary loading-htmx"
                                hx-post="{% url 'billing:change_plan' %}"
                                hx-vals='{"plan_name": "Growth"}'
                                hx-indicator="this"
                        >
                                <span class="loading-htmx-text">
                                    Change to plan
                                </span>
                            <span class="loading loading-spinner loading-htmx-loader"></span>
                        </button>
                    {% endif %}
                </div>
                <div class="flex flex-col p-6 mx-auto max-w-lg text-center rounded-lg border bg-base-300 shadow xl:p-8
                            dark:border-gray-600  border-gray-100">
                    <h3 class="mb-4 text-2xl font-bold">Enterprise</h3>
                    <p class="font-light text-gray-500 sm:text-lg dark:text-gray-400">
                        For large businesses or if your business needs a bit more
                        <span class="text-secondary font-bold"><i>customisation</i></span>
                    </p>
                    <div class="flex justify-center items-baseline my-8">
                        <span class="mr-2 text-5xl font-extrabold">
                            <span class="font-black">Custom</span>
                        </span>
                    </div>
                    <ul role="list" class="mb-8 space-y-4 text-left">
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Choose a price that fits your business</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>
                                Organization Mode
                                <span class="tooltip tooltip-primary"
                                      data-tip="Create additional accounts with specific permissions! (unlimited users)"
                                >
                                    <i class="fa fa-info-circle"></i>
                                </span>
                            </span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Dedicated Customer Success</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>SLA can be discussed</span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>
                                Analytics and live updates
                                <span class="tooltip tooltip-primary"
                                      data-tip="Get live updates + insights as customers open and read documents!"
                                >
                                    <i class="fa fa-info-circle"></i>
                                </span>
                            </span>
                        </li>
                        <li class="flex items-center space-x-3">
                            <i class="fa fa-check text-success"></i>
                            <span>Pre-release notifications</span>
                        </li>
                    </ul>
                    <a href="#" class="btn btn-primary">
                        Contact Us
                    </a>
                </div>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Starter Plan -->
                <div class="card w-full rounded-lg border bg-base-300 shadow dark:border-gray-600 border-gray-100">
                    <div class="card-body">
                        <div class="card-title text-lg font-semibold">
                            Starter Plan Usage-Based Pricing
                        </div>

                        <hr class="my-3" />

                        <!-- Invoices Section -->
                        <div tabindex="0" class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box">
                            <input type="checkbox" class="peer" />
                            <div class="collapse-title text-xl font-medium">
                                Invoices
                            </div>
                            <div class="collapse-content">
                                <table class="table table-auto w-full mt-2">
                                    <thead>
                                    <tr>
                                        <th class="text-left">Quantity</th>
                                        <th class="text-left">Unit Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>First 10 invoices</td>
                                        <td>Included for free</td>
                                    </tr>
                                    <tr>
                                        <td>Next 40 invoices</td>
                                        <td>£0.05/invoice</td>
                                    </tr>
                                    <tr>
                                        <td>Greater than 50 invoices</td>
                                        <td>£0.035/invoice</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Recurring Invoices Section -->
                        <div tabindex="0" class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box mt-4">
                            <input type="checkbox" class="peer" />
                            <div class="collapse-title text-xl font-medium">
                                Recurring Invoices
                            </div>
                            <div class="collapse-content">
                                <table class="table table-auto w-full mt-2">
                                    <thead>
                                    <tr>
                                        <th class="text-left">Quantity</th>
                                        <th class="text-left">Unit Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>First 2 invocations</td>
                                        <td>Included for free</td>
                                    </tr>
                                    <tr>
                                        <td>Next 8 invocations</td>
                                        <td>£0.08/invocation</td>
                                    </tr>
                                    <tr>
                                        <td>Greater than 8 invocations</td>
                                        <td>£0.05/invocation</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Growth Plan -->
                <div class="card w-full rounded-lg border bg-base-300 shadow dark:border-gray-600 border-gray-100">
                    <div class="card-body">
                        <div class="card-title text-lg font-semibold">
                            Growth Plan Usage-Based Pricing
                        </div>

                        <hr class="my-3" />

                        <!-- Invoices Section -->
                        <div tabindex="0" class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box">
                            <input type="checkbox" class="peer" />
                            <div class="collapse-title text-xl font-medium">
                                Invoices
                            </div>
                            <div class="collapse-content">
                                <table class="table table-auto w-full mt-2">
                                    <thead>
                                    <tr>
                                        <th class="text-left">Quantity</th>
                                        <th class="text-left">Unit Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>First 10 invoices</td>
                                        <td>Included for free</td>
                                    </tr>
                                    <tr>
                                        <td>Next 40 invoices</td>
                                        <td>£0.05/invoice</td>
                                    </tr>
                                    <tr>
                                        <td>Greater than 50 invoices</td>
                                        <td>£0.035/invoice</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Recurring Invoices Section -->
                        <div tabindex="0" class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box mt-4">
                            <input type="checkbox" class="peer" />
                            <div class="collapse-title text-xl font-medium">
                                Recurring Invoices
                            </div>
                            <div class="collapse-content">
                                <table class="table table-auto w-full mt-2">
                                    <thead>
                                    <tr>
                                        <th class="text-left">Quantity</th>
                                        <th class="text-left">Unit Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>First 2 invocations</td>
                                        <td>Included for free</td>
                                    </tr>
                                    <tr>
                                        <td>Next 8 invocations</td>
                                        <td>£0.08/invocation</td>
                                    </tr>
                                    <tr>
                                        <td>Greater than 8 invocations</td>
                                        <td>£0.05/invocation</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Invoice Reminders Section (Only Growth Plan) -->
                        <div tabindex="0" class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box mt-4">
                            <input type="checkbox" class="peer" />
                            <div class="collapse-title text-xl font-medium">
                                Invoice Reminders
                            </div>
                            <div class="collapse-content">
                                <table class="table table-auto w-full mt-2">
                                    <thead>
                                    <tr>
                                        <th class="text-left">Quantity</th>
                                        <th class="text-left">Unit Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>First 400 invocations</td>
                                        <td>Included for free</td>
                                    </tr>
                                    <tr>
                                        <td>Next 600 invocations</td>
                                        <td>£0.02/invocation</td>
                                    </tr>
                                    <tr>
                                        <td>Greater than 1000 invocations</td>
                                        <td>£0.01/invocation</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Advanced Onboarding Section (Only Growth Plan) -->
                        <div tabindex="0" class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box mt-4">
                            <input type="checkbox" class="peer" />
                            <div class="collapse-title text-xl font-medium">
                                Advanced Onboarding
                            </div>
                            <div class="collapse-content">
                                <table class="table table-auto w-full mt-2">
                                    <thead>
                                    <tr>
                                        <th class="text-left">Quantity</th>
                                        <th class="text-left">Unit Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>First 5 customers</td>
                                        <td>£0.00/customer</td>
                                    </tr>
                                    <tr>
                                        <td>Next 20 customers</td>
                                        <td>£0.08/customer</td>
                                    </tr>
                                    <tr>
                                        <td>Greater than 25 customers</td>
                                        <td>£0.05/customer</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="divider">Change plan</div>
            <form hx-post="{% url 'billing:change_plan' %}" hx-swap="none">
                <select class="select select-bordered select-sm" name="plan_id">
                    {% for option in all_subscription_plans %}
                        <option value="{{ option.id }}">
                            {{ option.name | title }} -
                            {% if option.price_per_month != -1 %}
                                                      £{{ option.price_per_month }}
                            {% else %}
                                                      Custom Price
                            {% endif %}
                            {% if option.maximum_duration_months %}({{ option.maximum_duration_months }} month max){% endif %}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-secondary btn-sm">submit</button>
            </form>
        </div>
    </div>
    <div class="card bg-base-100 mb-2">
        <div class="card-body">
            <div class="card-title mb-6">
                All Subscriptions
            </div>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Status</th>
                    <th>Plan Name</th>
                    <th>Price</th>
                    <th>Started</th>
                    <th>Ended</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for subscription in all_user_subscriptions|dictsortreversed:"start_date" %}
                    <tr>
                        <td>
                            {% if subscription.has_ended %}
                                <span class="badge badge-error badge-outline py-3 border-2 font-bold">Ended</span>
                            {% else %}
                                <span class="badge badge-success badge-outline py-3 border-2 font-bold">Ongoing</span>
                            {% endif %}
                        </td>
                        <td>{{ subscription.subscription_plan.name }}</td>
                        <td>{{ subscription.subscription_plan.price_per_month }}</td>
                        <td>{{ subscription.start_date }}</td>
                        {% if subscription.has_ended %}
                            <td>{{ subscription.end_date | default_if_none:"" }}</td>
                        {% else %}
                            <td>
                                <span class="block w-4 border-0 border-t-[2px]"></span>
                            </td>
                            <td>
                                <button class="btn btn-error btn-sm loading-htmx"
                                        hx-get="{% url 'billing:stripe_customer_portal' %}?back=/dashboard/billing/"
                                        hx-indicator="this"
                                >
                                <span class="loading-htmx-text">
                                    Cancel
                                </span>
                                    <span class="loading loading-spinner loading-htmx-loader"></span>
                                </button>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
